@page
@model CrudWebApp.Pages.IndexModel
@{
    ViewData["Title"] = "Inventory";
}

<div class="d-flex justify-content-between mb-4">
    <h2>Product Inventory</h2>
    <div>
        <button class="btn btn-info text-white" onclick="openBulkModal()">Add Bulk</button>
        <button class="btn btn-primary" onclick="openModal()">New Product</button>
    </div>
</div>

<table class="table table-bordered table-hover">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in Model.ProductData.Items)
        {
            <tr>
                <td>@p.Id</td>
                <td>@p.Name</td>
                <td>$@p.Price</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="openModal(@p.Id, '@p.Name', @p.Price)">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(@p.Id)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mTitle">Product</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <label>Name</label><input type="text" id="pName" class="form-control mb-2">
                <label>Price</label><input type="number" id="pPrice" class="form-control" step="0.01">
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveProduct()">Save</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Format: Name, Price (one per line)</p>
                <textarea id="bulkData" class="form-control" rows="5"></textarea>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveBulk()">Submit</button></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API = "http://localhost:5001";
        let pModal, bModal;

        document.addEventListener("DOMContentLoaded", () => {
            pModal = new bootstrap.Modal(document.getElementById('productModal'));
            bModal = new bootstrap.Modal(document.getElementById('bulkModal'));
        });

        window.openModal = (id, name, price) => {
            document.getElementById('mTitle').innerText = id ? "Edit Product" : "New Product";
            document.getElementById('pId').value = id || "";
            document.getElementById('pName').value = name || "";
            document.getElementById('pPrice').value = price || "";
            pModal.show();
        };

        window.openBulkModal = () => {
            document.getElementById('bulkData').value = "";
            bModal.show();
        };

        window.saveProduct = async function () {
            const idVal = document.getElementById('pId').value; // or 'productId'
            const nameVal = document.getElementById('pName').value; // or 'productName'
            const priceVal = document.getElementById('pPrice').value; // or 'productPrice'

            // 1. FORCE NUMBERS (Crucial!)
            const product = {
                id: idVal ? parseInt(idVal) : 0,
                name: nameVal,
                price: parseFloat(priceVal)
            };

            // 2. CHECK URL (Must match your API port 5001)
            const url = idVal ? `http://localhost:5001/products/${idVal}` : `http://localhost:5001/products`;
            const method = idVal ? "PUT" : "POST";

            try {
                const response = await fetch(url, {
                    method: method,
                    // 3. HEADER IS MANDATORY
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(product)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    // Read the error message from the server
                    const errorText = await response.text();
                    console.error("Server Error:", errorText);
                    alert("Error: " + errorText);
                }
            } catch (error) {
                console.error("Network Error:", error);
                alert("Could not connect to API at " + url);
            }
        }

        window.deleteProduct = async (id) => {
            if (confirm("Delete?")) {
                await fetch(`${API}/products/${id}`, { method: "DELETE" });
                location.reload();
            }
        };

        window.saveBulk = async () => {
            const lines = document.getElementById('bulkData').value.split('\n');
            const products = [];
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length === 2) products.push({ name: parts[0].trim(), price: parseFloat(parts[1].trim()) });
            });

            if (products.length > 0) {
                await fetch(`${API}/products/bulk`, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(products)
                });
                location.reload();
            }
        };
    </script>
}